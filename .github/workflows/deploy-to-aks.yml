name: Deploy to AKS

on:
  workflow_dispatch:
    inputs:
      cluster-name:
        description: 'AKS cluster name'
        required: true
        default: 'headlamp-thgamble'
        type: string
      resource-group:
        description: 'Azure resource group'
        required: true
        default: 'thgamble'
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: true
        default: 'yet-another'
        type: string
      subscription-id:
        description: 'Azure subscription ID'
        required: true
        default: 'd98169bc-2d4a-491b-98cb-b69cbf002eb0'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ inputs.subscription-id }}

    - name: Get ACR details and login
      id: acr
      run: |
        # Get the ACR login server
        ACR_NAME=$(az acr list --resource-group ${{ inputs.resource-group }} --query "[0].name" -o tsv)
        ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
        echo "acr-name=$ACR_NAME" >> $GITHUB_OUTPUT
        echo "acr-login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
        
        # Login to ACR using the OIDC token from Azure Login
        az acr login --name $ACR_NAME

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ steps.acr.outputs.acr-login-server }}/grpc-retry-fun:1.0
          ${{ steps.acr.outputs.acr-login-server }}/grpc-retry-fun:${{ github.sha }}
          ${{ steps.acr.outputs.acr-login-server }}/grpc-retry-fun:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false

    - name: Update Kubernetes manifests
      run: |
        # Update image reference in deployment manifest
        sed -i "s|image: grpc-retry-fun:1.0|image: ${{ steps.acr.outputs.acr-login-server }}/grpc-retry-fun:1.0|g" deploy/kubernetes/deployment.yaml

    - name: Set AKS context
      uses: azure/aks-set-context@v4
      with:
        resource-group: ${{ inputs.resource-group }}
        cluster-name: ${{ inputs.cluster-name }}

    - name: Create namespace if not exists
      run: |
        kubectl create namespace ${{ inputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

    - name: Deploy to AKS
      run: |
        kubectl apply -f deploy/kubernetes/ -n ${{ inputs.namespace }}

    - name: Wait for deployment rollout
      run: |
        kubectl rollout status deployment/grpc-retry-fun -n ${{ inputs.namespace }} --timeout=5m

    - name: Verify deployment
      run: |
        echo "=== Deployment Status ==="
        kubectl get deployment grpc-retry-fun -n ${{ inputs.namespace }}
        echo ""
        echo "=== Pods ==="
        kubectl get pods -n ${{ inputs.namespace }} -l app=grpc-retry-fun
        echo ""
        echo "=== Service ==="
        kubectl get svc grpc-retry-fun -n ${{ inputs.namespace }}
        echo ""
        echo "=== HPA ==="
        kubectl get hpa grpc-retry-fun -n ${{ inputs.namespace }} || echo "HPA not available yet"

    - name: Display recent logs
      if: always()
      run: |
        echo "=== Recent Application Logs ==="
        kubectl logs -n ${{ inputs.namespace }} -l app=grpc-retry-fun --tail=50 --prefix=true || echo "No logs available"
