name: Deploy to AKS

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  CLUSTER_NAME: headlamp-thgamble
  RESOURCE_GROUP: thgamble
  NAMESPACE: yet-another
  APP_NAME: grpc-retry-fun

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: b06f66c5-f30b-4797-8dec-52cc6568e9aa
          subscription-id: d98169bc-2d4a-491b-98cb-b69cbf002eb0

      - name: Get ACR login server
        id: get-acr
        run: |
          ACR_LOGIN_SERVER=$(az acr show --name ${{ env.ACR_NAME }} --query loginServer --output tsv)
          echo "acr_login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Login to ACR
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push Docker image
        id: build-image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t ${{ steps.get-acr.outputs.acr_login_server }}/${{ env.APP_NAME }}:$IMAGE_TAG .
          docker push ${{ steps.get-acr.outputs.acr_login_server }}/${{ env.APP_NAME }}:$IMAGE_TAG
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Set up kubeconfig
        uses: azure/aks-set-context@v4
        with:
          cluster-name: ${{ env.CLUSTER_NAME }}
          resource-group: ${{ env.RESOURCE_GROUP }}

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to AKS
        run: |
          export ACR_NAME=${{ steps.get-acr.outputs.acr_login_server }}
          export IMAGE_TAG=${{ steps.build-image.outputs.image_tag }}
          
          # Replace placeholders in deployment manifests
          envsubst < deploy/kubernetes/deployment.yaml | kubectl apply -f -
          kubectl apply -f deploy/kubernetes/service.yaml

      - name: Wait for deployment rollout
        run: |
          kubectl rollout status deployment/${{ env.APP_NAME }} -n ${{ env.NAMESPACE }} --timeout=5m

      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }}
          kubectl get svc -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }}
