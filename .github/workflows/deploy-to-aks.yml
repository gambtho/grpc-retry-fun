name: Deploy to AKS

on:
  workflow_dispatch:
    inputs:
      cluster-name:
        description: 'AKS cluster name'
        required: true
        default: 'dt'
        type: string
      resource-group:
        description: 'Azure resource group'
        required: true
        default: 'thgamble'
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: true
        default: 'a-project'
        type: string
      subscription-id:
        description: 'Azure subscription ID'
        required: true
        default: 'd98169bc-2d4a-491b-98cb-b69cbf002eb0'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ inputs.subscription-id }}
    
    - name: Set AKS context
      uses: azure/aks-set-context@v4
      with:
        cluster-name: ${{ inputs.cluster-name }}
        resource-group: ${{ inputs.resource-group }}
    
    - name: Verify kubectl connection
      run: |
        kubectl version --client
        kubectl cluster-info
        kubectl get nodes
    
    - name: Create namespace if not exists
      run: |
        kubectl create namespace ${{ inputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f deploy/kubernetes/ -n ${{ inputs.namespace }}
    
    - name: Annotate deployments with pipeline run URL
      run: |
        kubectl annotate deployment --all \
          -n ${{ inputs.namespace }} \
          aks-desktop/pipeline-run-url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          --overwrite
    
    - name: Wait for deployment rollout
      run: |
        kubectl rollout status deployment/grpc-retry-fun -n ${{ inputs.namespace }} --timeout=5m
    
    - name: Get deployment status
      if: always()
      run: |
        echo "=== Deployment Status ==="
        kubectl get deployments -n ${{ inputs.namespace }}
        echo ""
        echo "=== Pods Status ==="
        kubectl get pods -n ${{ inputs.namespace }} -l app=grpc-retry-fun
        echo ""
        echo "=== Service Status ==="
        kubectl get services -n ${{ inputs.namespace }} -l app=grpc-retry-fun
        echo ""
        echo "=== Recent Events ==="
        kubectl get events -n ${{ inputs.namespace }} --sort-by='.lastTimestamp' | tail -20
